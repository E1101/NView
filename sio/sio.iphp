<?php
mb_internal_encoding('UTF-8');

class SIO {
	public static function run($v=NULL) {
		if (is_null($v)) {
			$v = new NView('sio_v.ixml');
			$err = $v->messages();
		}
		if (isset($err) && !empty($err)) {
			echo $err;
		} else {
/*
This is the SIO widget, so it is going to handle everything to do with 
sign-in and sign-out.
*/	
			$formlet=null;
			if (Session::has('username')) { //signed in.
				if (SioSignOut::inscope(true)) { //doing a sign-out post.
					$sso=new SioSignOut(); $formlet=$sso->form();
					if ($sso->success()) {
						print('ping');
						$sio=new SioSignIn(); $formlet=$sio->form(false);
					} else {
						print('pong');
					}
				} else {
					if (SioSetPW::inscope(true)) {  //doing a set-pw post.
						$sio=new SioSetPW(); $formlet=$sio->form();
					} else {
						$sio=new SioSignOut(); $formlet=$sio->form();
					}
				}
			} else { //not-signed in
				if (SioSignIn::inscope(false)) {	//currently processing a signin..
					$ssi=new SioSignIn(); $formlet=$ssi->form(false);
					if ($ssi->success()) {
						$sio=new SioSignOut(); $formlet = $sio->form(false);
					} 
				} elseif (SioReg::inscope(false)) {
					$sio=new SioReg(); $formlet=$sio->form(false);
				} elseif (SioSetPW::inscope(true)) {
					$sio=new SioSetPW(); $formlet=$sio->form(false);
				} elseif (SioForgot::inscope(false)) {
					$sio=new SioForgot(); $formlet=$sio->form(false);
				} elseif (SioSignOut::inscope(false)) {
					$sso=new SioSignOut(); $formlet=$sso->form(false);
					if ($sso->success()) {
						$sio=new SioSignIn(); $formlet = $sio->form(false);
					} 
				} else {
					if (Session::has('username')) {
						$sio=new SioSignOut(); $formlet=$sio->form(false);
					} else {
						$sio=new SioSignIn(); $formlet=$sio->form(false);
					}
				}		
			}
			$v->set("//*[@data-xp='sio']",$formlet);
			return $v;
		}
	}
}
